//  var FM = window.FM || {}; Using in Browser

var DEBUG = true,
    FM_LOG = (DEBUG) ? function(str){ logger.log(str); } : function(str){} ;
    
var FM = {};

//  A Singleton of MongoDB
FM.DB = (function(){
    var uInstance = null;
    
    function constructor(){
        // Private members.
        var mongodb = require('mongodb'),
            mongoose = require('mongoose'),
            assert = require('assert'),
            Schema = mongoose.Schema,
            ObjectID = Schema.Types.ObjectId,
            Mixed = Schema.Types.Mixed,
            DB = 'feltmeng',
            connection = connectDB(),
            eduLv = 'elem jrHigh srHigh college university master doctor'.split(' '),
            occupationList = 'gov student edu industry business service'.split(' '),
            evtStatus = 'waiting proved'.split(' '), //DEPRECATED, not used in v1.2 or later
            UGCStatus = 'good soso bad waiting none'.split(' '),
            UGCGenre = 'miix miix_street miix_story cultural_and_creative mood check_in'.split(' '),
            //miix: "Miix Video", generated by combining user content and template video (a.k.a. 合成影片) 
            //miix_street: "Street video", captured by shooting DOOH playing Miix video. Not used by Miix apps so far
            //miix_story: "Story MV", generated by combining Miix Video and Street Video
            //cultural_and_creative: a.k.a. 文創
            //mood: a.k.a. 心情
            //check_in: a.k.a. 打卡
            questionGenre = 'account authorize sign_in '.split(' '),
            
            programTimeSlotType = 'UGC padding'.split(' '),
            programTimeSlotContnetType = 'file web_page'.split(' '),
            
            videoStatus = 'good soso bad waiting none'.split(' '), //DEPRECATE, keep for reference
            videoGenre = 'miix miix_street miix_story'.split(' '); //DEPRECATE, keep for reference 
            //programTimeSlotStatus = 'waiting proved'.split(' ');
        
		/****************** DB Schema ******************/
		
        /*  fb: { userID: {type: String},
				  userName: {type: String},
         *          auth: { accessToken: {type: String},
         *                  expiresIn: {type: Number},
         *                  signedRequest: {type: String}
         *          },
         *  }
         *
         */

		
        var MemberSchema = new Schema({
            fb: {type: Mixed},  //  Facebook, Carefull! don't use {type: [Mixed]}
            fullname: {type: String},
            memberID: {type: String},
            password: {type: String},
			deviceToken: {type: Mixed},
            mPhone: { number: String, verified: {type: Boolean, default: false}, code: String },
            email: {type: String, default: 'xyz@feltmeng.com'},
            birthday: {type: Number, min:19110101},
            occupation: {type: String, enum: occupationList},
            gender: {type: Boolean},    //  0:Male 1:Female
            education: {type: String, enum: eduLv},
            notification: {type: Boolean, default: true},
            ugc_ids: {type: [ObjectID]},
            activity_ids: {type: [ObjectID]},
            ugc_count: {type: Number, min: 0, default: 0},
            thumbnail: {type: String},    //  path/to/filename
			doohTimes: {type: Number, min: 0, default: 0}
        }); //  members collection
        
      //DEPRECATED - keep for now for reference
        var VideoSchema = new Schema({
            fb_id: {type: String},
            title: {type: String},
            description: {type: String},
            url: { youtube: String, tudou: String },  //  Youtube, Tudou
            ownerId: { _id:ObjectID, userID: String },
            locationId: {type: ObjectID},
            projectId: {type: String},  //  AE project ID
            hitRate: {type: Number, min:0},
            comments: {type: Mixed},    //  "data": []
            vote: {type: Number, default: 0, min:0},
            likes: {type: Number, default: 0, min:0},
            status: {type: String, enum: videoStatus, default: 'none'},
			createdOn: {type: Date, default: Date.now},
			doohTimes: { times: {type: Number, default: 0, min: 0}, event: [ObjectID], submited_time: Date},
			playedTimes: {type: Number, min: 0},
			review: {type: Number},
			vip: {type: Boolean, default: false},
            genre: {type: String, enum: videoGenre, default: 'miix'},
            no: {type: Number},
            aeId: {type: String},
			triedDoohTimes: {type: Number, min: 0, default: 0},	//JF
			doohPlayedTimes: {type: Number, min: 0, default: 0},	//JF
			timesOfPlaying: {type: Number}		//JF
        }); //  videos collection
        
        var UGCSchema = new Schema({
            fb_id: {type: String}, //ID of the corresponding FB feed 
            title: {type: String},
            description: {type: String},
            url: { youtube: String, tudou: String, s3: String },  //  Youtube, Tudou
            userRawContent: { image: String, text: String, video: String }, // the file path or S3 URL of storing user's image, text, or video
            ownerId: { _id:ObjectID, userID: String },
            locationId: {type: ObjectID},
            projectId: {type: String},  // project ID which is unique to each AE rendering
            hitRate: {type: Number, min:0},
            comments: {type: Mixed},    //  "data": []
            vote: {type: Number, default: 0, min:0},
            likes: {type: Number, default: 0, min:0},
            status: {type: String, enum: UGCStatus, default: 'none'},
            createdOn: {type: Date, default: Date.now},
            doohTimes: { times: {type: Number, default: 0, min: 0}, event: [ObjectID], submited_time: Date},
            playedTimes: {type: Number, min: 0},
            review: {type: Number},
            vip: {type: Boolean, default: false},
            genre: {type: String, enum: UGCGenre, default: 'miix'},
            no: {type: Number}, //Unique serial number shown to user  
            aeId: {type: String}, //ID of AE Server who renders this UGC
            mediaType: {type: String},
            fileExtension: {type: String},
            triedDoohTimes: {type: Number, min: 0, default: 0}, //JF
            doohPlayedTimes: {type: Number, min: 0, default: 0},    //JF
            timesOfPlaying: {type: Number},     //JF
            mustPlay: {type: Boolean, default: false},
            rating: {type: String} //range A~E      kaiser
        }); //  UGC collection
        
        var CommentSchema = new Schema({
            fb_id: {type: String},
            owner_id: {type: ObjectID},
            message: {type: String}
        }); //  comments collection
        
        //DEPRECATED - wasn't used in v1.2 or later
        var EventSchema = new Schema({
            video: { _id: ObjectID,
                     projectId: String,
                     url: String
                   },
            ownerId: { _id: ObjectID, userID: String },
            dooh: {client: String, location: String},
            timeslot: { start: Date, end: Date, sequence: Number, duration: String  },
            status: {type: String, enum: evtStatus} //TODO: may not need
        }); //  events collection for schedule
        
        //DEPRECATED - wasn't used in v1.2 or later
        var ProgramSchema = new Schema({
            dooh: {id: String, location: String},
            program: [{
                mode: String,
                day: Number,
                date: String,
                start_date: String,
                end_date: String,
                start: String,
                end: String,
                sequence: Number,
                duration: String,
            }]
        });
        
        var ProgramTimeSlotSchema = new Schema({
            content: {type: Mixed},
            contentType: {type: String, enum: programTimeSlotContnetType}, //file or web_page
            dooh: {type: String},
            timeslot: { 
                start: Number, 
                end: Number, 
                startHour: Number 
                },
            timeStamp: {type: String},
            //status: {type: String, enum: programTimeSlotStatus}
            type: {type: String, enum: programTimeSlotType}, //UGC or padding contnet
            genre: {type: String, enum: UGCGenre} //miix, miix_street, miix_story, cultural_and_creative, mood, or check_in
        }); 
        
        var CandidateUgcCacheSchema = new Schema({
            sessionId: {type: String},
            index: {type: Number},
            candidateUgc: {type: Mixed}
        });
        
        var AdminSchema = new Schema({
            id: {type: String},
            password: {type: String}
        });
        
        
		var AnalysisSchema = new Schema({
			time: {type: Date},
			user_id: {type: ObjectID},
			userName: {type: String},
			fb_id: {type: String},
			action: {type: String},
			platform: {type: String},
			os_version: {type: String}
		}); 

        //kaiser start **************
        var MemberListInfoSchema = new Schema({
            fb: {type: Mixed},  //  Facebook, Carefull! don't use {type: [Mixed]}
            email: {type: String, default: 'xyz@feltmeng.com'},
            mPhone: { number: String, verified: {type: Boolean, default: false}, code: String },
            miixMovieVideo_count: {type: Number, min: 0, default: 0}, //已製作影片數
            doohPlay_count: {type: Number, min: 0, default: 0},       //DOOH刊登次數
            movieViewed_count: {type: Number, min: 0, default: 0},    //影片觀看總次數
            fbLike_count: {type: Number, min: 0, default: 0},         //FB讚總數
            fbComment_count: {type: Number, min: 0, default: 0},      //FB留言總數
            fbShare_count: {type: Number, min: 0, default: 0}         //FB分享次數
            
        }); //  memberListInfo collection
        
        var MiixPlayListInfoSchema = new Schema({
            projectId: {type: String},                                //  AE project ID
            userPhotoUrl: {type: String},                             //素材照片
            movieNo: {type: Number},                                  //影片編號
            movieViewed_count: {type: Number, min: 0, default: 0},    //影片觀看總次數
            fbLike_count: {type: Number, min: 0, default: 0},         //FB讚次數
            fbComment_count: {type: Number, min: 0, default: 0},      //FB留言數
            fbShare_count: {type: Number, min: 0, default: 0},        //FB分享次數
            movieMaker: {type: String},                               //會員名稱
            applyDoohPlay_count: {type: Number, min: 0, default: 0},  //投稿次數
            doohPlay_count: {type: Number, min: 0, default: 0},       //DOOH刊登次數
            timesOfPlaying: {type: Number}      
            
        }); //  miixPlayListInfo collection
        
        var StoryPlayListInfoSchema = new Schema({
            projectId: {type: String},                                //  AE project ID
            movieNo: {type: Number},                                  //影片編號
            movieViewed_count: {type: Number, min: 0, default: 0},    //觀看次數
            fbLike_count: {type: Number, min: 0, default: 0},         //FB讚次數
            fbComment_count: {type: Number, min: 0, default: 0},      //FB留言數
            fbShare_count: {type: Number, min: 0, default: 0},        //FB分享次數
            movieMaker: {type: String}                                //會員名稱
            
        }); //  storyPlayListInfo collection
        
         //kaiser end ***************		
        var CustomerServiceSchema = new Schema({
            fb_id: {type: String},
            no: {type: Number},
            genre: {type: String, enum: questionGenre},
            reply: { type: Boolean },
            version: { type: String },
            content: [{
                question: String,
                questionTime: Date,
                answer: String,
                answerTime: Date,
            }],                                  
            remarks: {type: String}
        }); //   customerService collection
		
        /****************** End of DB Schema ******************/
		
        var Member = connection.model('Member', MemberSchema, 'member'),
            Video = connection.model('Video', VideoSchema, 'video'),
            Comment = connection.model('Comment', CommentSchema, 'comment'),
            Event = connection.model('Event', EventSchema, 'event'), //DEPRECATED
            Program = connection.model('Program', ProgramSchema, 'program'), //DEPRECATED
            ProgramTimeSlot = connection.model('ProgramTimeSlot', ProgramTimeSlotSchema, 'programTimeSlot'),
            CandidateUgcCache = connection.model('CandidateUgcCache', CandidateUgcCacheSchema, 'candidateUgcCache'),
            Admin = connection.model('Admin', AdminSchema, 'admin'),
			Analysis = connection.model('Analysis', AnalysisSchema, 'analysis'),
            MemberListInfo = connection.model('MemberListInfo', MemberListInfoSchema, 'memberListInfo'),//kaiser
            MiixPlayListInfo = connection.model('MiixPlayListInfo', MiixPlayListInfoSchema, 'miixPlayListInfo'),
            StoryPlayListInfo = connection.model('StoryPlayListInfo', StoryPlayListInfoSchema, 'storyPlayListInfo'),
            UGC = connection.model('UGC', UGCSchema, 'ugc');
            CustomerService = connection.model('CustomerService', CustomerServiceSchema, 'customerService');
           
            
        var dbModels = [];
        dbModels["member"] = Member;
        dbModels["video"] = Video;
        dbModels["comment"] = Comment;
        dbModels["event"] = Event;
        dbModels["program"] = Program;
        dbModels["programTimeSlot"] = ProgramTimeSlot;
        dbModels["candidateUgcCache"] = CandidateUgcCache;
        dbModels["admin"] = Admin;
		dbModels["analysis"] = Analysis;
        dbModels["memberListInfo"] = MemberListInfo;//kaiser
        dbModels["miixPlayListInfo"] = MiixPlayListInfo;
        dbModels["storyPlayListInfo"] = StoryPlayListInfo;  
        dbModels["ugc"] = UGC;
        dbModels["customerService"] = CustomerService;
        
        //???? nobody uses it, so this section can be removed? 
        var dbSchemas = [];
        dbSchemas["member"] = MemberSchema;
        dbSchemas["video"] = VideoSchema;
        dbSchemas["comment"] = CommentSchema;
        dbSchemas["event"] = EventSchema;
        dbSchemas['program'] = ProgramSchema;
        dbSchemas["admin"] = AdminSchema;
		dbSchemas["analysis"] = AnalysisSchema;
        dbSchemas['memberListInfo'] = MemberListInfoSchema;//kaiser
        dbSchemas["miixPlayListInfo"] = MiixPlayListInfoSchema;
        dbSchemas["storyPlayListInfo"] = StoryPlayListInfoSchema;
        dbSchemas["ugc"] = UGCSchema;
            
        function connectDB(){
                try{
                    mongoose.connect('mongodb://192.168.5.189:27017/'+DB);
                    return mongoose.connection;
                }catch(err){
                    logger.info('Connect DB failed: '+err);
                }
            };

        return {
        /*  
         *  Public members. In Constructor().
         */
            locatioinQuery: function(locationUID){
                var query = UGC.find({});
                query.sort('timestamp', -1).exec(function(err, doc){
                    if(err){
                        logger.info('locationQuery failed: '+err);
                    }else{
                        logger.info('locationQuery '+locationUID+': '+doc);
                    }
                });
            },

            ownerQuery: function(ownerUID){
                var query = UGC.find({});
                query.where('_id', ownerUID).sort('timestamp', -1).exec(function(err, doc){
                    if(err){
                        logger.info('ownerQuery failed: '+err);
                    }else{
                        logger.info('ownerQuery '+ownerUID.toHexString());
                    }
                });
            },

            latestQuery: function(latestNum){
                var query = UGC.find({});
                query.sort('timestamp', -1),limit(latestNum).exec(function(err, doc){
                    if(err){
                        logger.info('latestQuery failed: '+err);
                    }else{
                        logger.info('latestQuery Latest'+latestNum+': '+doc);
                    }
                });
            },

            rankQuery: function(topNum){
                var query = UGC.find({});
                query.sort('hitRate', -1).limit(topNum).exec(function(err, doc){
                    if(err){
                        logger.info('rankQuery failed: '+err);
                    }else{
                        logger.info('rankQuery TOP'+topNum+': '+doc);
                    }
                });
            },
            
           
            getDocModel2: function(collection){
                switch(collection){
                    case 'member':
                        return Member;
                        break;
                    case 'video':
                        return Video;
                        break;
                    case 'comment':
                        return Comment;
                        break;
                    case 'event':
                        return Event;
                        break;
                    case 'memberListInfo':
                        return MemberListInfo;
                        break;
                    case 'miixPlayListInfo':
                        return MiixPlayListInfo;
                        break;
                    case 'storyPlayListInfo':
                        return StoryPlayListInfo;
                        break;
                    case 'ugc':
                        return UGC;
                        break;
                    case 'customerService':
                        return CustomerService;
                        break;
                    default:
                        throw new error('DB Cannot find this Collection: ' + collection);
                        break;
                }
            },
            
            getDocModel: function(collection){
                return dbModels[collection];
            },

            createAdoc2: function(collection, jsonObj, ownerId){
                if(arguments.length == 1)
                    throw new error('Must have at least 2 arguments.');
                
                var docModel = this.getDocModel(collection);
                var doc = new docModel(jsonObj);
                if('undefined' != typeof(ownerId))    
                    doc.ownerId = ownerId;
                doc.save();
                logger.info("Create a Doc: "+doc);
                
            },
            
            /*
             * createAdoc(docModel, jsonObj);
             * 
             */
            createAdoc: function(docModel, jsonObj, callback){
                
                if(arguments.length == 1)
                    throw new error('Must have 2 arguments.');
                
                var doc = new docModel(jsonObj);
                
                if(jsonObj.fb) {
                    FM_LOG("\n[doc.fb markModified]");
                    doc.markModified('fb');
                }
                ('undefined' === typeof callback) ? doc.save() : doc.save(callback);
                
            },

            //  function createAmember(collection, jsonObj){ createAdoc(collection, jsonObj, null); }  //for Member doc without ID neccesary
            readAdocById: function(docModel, docid, cb){
                if(arguments.length != 3){
                    throw new Error('Must have 3 arguments.');
                    
                }else{
                    docModel.findById(docid, cb);
                }
            },
            
            readAdoc: function(docModel, condition, cb){
                if(arguments.length != 3)
                    throw new error('Must have 3 arguments.');
                docModel.findOne(condition, cb);
            },

            updateAdoc: function(docModel, docid, jsonObj, cb){
                //logger.info("\n updateAdoc " + " fields: " + JSON.stringify(jsonObj));
                docModel.findByIdAndUpdate(docid, {$set: jsonObj}, cb);
            },
            
			updateOne: function(docModel, condition, jsonObj, options, cb){
				FM_LOG("\n[updateOne]");
				docModel.findOneAndUpdate(condition, {$set: jsonObj}, options, cb);
			},
			
            deleteAdoc: function(docModel, docid, cb){
                logger.info("Delete a Doc: " + docid);
                docModel.findByIdAndRemove(docid, cb);
            },
            //kaiser
            deleteAdoc2: function(docModel, cb){
                logger.info("Delete all Doc: ");
                docModel.remove(docModel, cb);
            },
            
            listOfdocModels: function(docModel,condition, fields, options, cb){
                docModel.find(condition, fields, options, cb);
            },
            //kaiser end
            getValueOfById: function(docModel, docid, path, cb){
                var doc = this.readAdocById(docModel, docid, function(err, result){
                    if(err)
                        throw err;
                    else
                        return doc.get(path);
                });
            },
            
            getValueOf: function(docModel, condition, field, cb){
                docModel.findOne(condition, field, cb);
            },
            
            
            ugcDump: function(){
                var Member = connection.model('Member', MemberSchema, 'member');
                var query = Member.find();
                var ownerId1 = ObjectID,
                    ownerId2 = ObjectID;
               
                query.exec(function(err, doc){
                    if(err){
                        logger.info('test failed: '+err);
                    }else{
                        ownerId1 = doc[0]._id;
                        ownerId2 = doc[1]._id;
                        logger.info('find(): '+ ownerId1.toHexString()+'\n'+ ownerId2.toHexString());
                        //var date = new Date( parseInt( json._id.slice(0,8), 16 ) * 1000 );
                        var title;
                        for(i=0; i<100; i++){
                            title = "Star-"+i;
                            //var doc = new Video({"title":title});
                            if(i%2 == 0){
                                createAdoc( connection, 'UGC', {"title":title}, ownerId1);
                            }else{
                                createAdoc( connection, 'UGC', {"title":title}, ownerId2);
                            }
                        }
                    }
                });
            },
            
            test: function(){
                //var docModel = this.getDocModel2("member");
                logger.info(dbModels["member"]);
            }
        };  // End of Return
    }   // End of Constructor
    
    return {
        getInstance: function(){
            if(!uInstance){
                uInstance = constructor();
            }
            return uInstance;
        }
    };  //  End of Return
})(); //  End of Singleton



module.exports = FM.DB.getInstance();






/* User Token
 * AAADdkgZCw4VMBALbOyseWQ4GU2CCfJhONZCOvVdiYAlYMtZApSx0iTwXYhkExINmgjQ59YDHmiZCzlmSMeKSLZAHOyZBZC1mkWwNRYKq5vB7BAC52akxDIu
 */
