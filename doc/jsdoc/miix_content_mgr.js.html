<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: miix_content_mgr.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: miix_content_mgr.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 * @fileoverview Implementation of miixContentMgr
 */

var workingPath = process.cwd();
var aeServerMgr = require(workingPath+'/ae_server_mgr.js');
var doohMgr = require(workingPath+'/dooh_mgr.js');
var memberDB = require(workingPath+'/member.js');
var UGCDB = require(workingPath+'/ugc.js');
var fmapi = require(workingPath+'/routes/api.js');   //TODO:: find a better name

var fs = require('fs');
var path = require('path');
var xml2js = require('xml2js');

/**
 * The manager who coordinates the operations for Miix contents
 *
 * @mixin
 */
var miixContentMgr = {};


/**
 * Coordinate AE server to render Miix movie and save the content info to UGC db
 * 
 * @param {String} movieProjectID
 * @param {String} ownerStdID
 * @param {String} ownerFbID
 * @param {String} movieTitle
 */
miixContentMgr.generateMiixMoive = function(movieProjectID, ownerStdID, ownerFbID, movieTitle) {
    
    //console.log('generateMiixMoive is called.');
    //var mediaType = "H.264";
    var mediaType = "FLV";
    
    aeServerMgr.createMiixMovie( movieProjectID, ownerStdID, ownerFbID, movieTitle, mediaType, function(responseParameters){
        
        if ( responseParameters.youtube_video_id ) {
            var aeServerID = responseParameters.ae_server_id;
            var youtubeVideoID = responseParameters.youtube_video_id;
            var movieProjectID = responseParameters.movie_project_id;
            var ownerStdID = responseParameters.owner_std_id;
            var ownerFbID = responseParameters.owner_fb_id;
            var movieTitle = responseParameters.movie_title;
            var fileExtension = responseParameters.movie_file_extension;
            
            
            if ( responseParameters.err == 'null' || (!responseParameters.err) ) {
                //post to FB; update video DB; push notification to mobile client 
                var url = {"youtube":"http://www.youtube.com/embed/"+youtubeVideoID};			
                var vjson = {"title": movieTitle,
                             "ownerId": {"_id": ownerStdID, "userID": ownerFbID},
                             "url": url,
                             "genre":"miix",
                             "aeId": aeServerID,
                             "projectId": movieProjectID,
                             "mediaType": mediaType,
                             "fileExtension": fileExtension
                             };
                fmapi._fbPostUGCThenAdd(vjson); //TODO: split these tasks to different rolls
                
            };
            
            //for test
            //miixContentMgr.submitMiixMovieToDooh('', movieProjectID);
        };
        
    });
    
};

/**
 * Coordinate DOOH server to download Miix Content
 * 
 * @param {String} doohID
 * @param {String} miixMovieProjectID
 * @deprecated since Miix 2.0
 */
miixContentMgr.submitMiixMovieToDooh = function( doohID, miixMovieProjectID ) {
   
    UGCDB.getValueByProject(miixMovieProjectID, "fileExtension", function(err3, result){ 
        if (result){
            var miixMovieFileExtension = result.fileExtension;
            doohMgr.downloadMovieFromS3(miixMovieProjectID, miixMovieFileExtension,  function(resParametes){
                logger.info('downloading Miix movie from S3.');
                logger.info('res: _command_id='+resParametes._command_id+' err='+resParametes.err);
                
            }); 
        }                              
        else {
            logger.error("UGCDB.getValueByProject() failed: "+err3);
        }
        
    });
    
};


/**
 * Add some info some preliminary info of Miix movie to UGC db while AE is rending its concrete content.&lt;br>  
 * &lt;br>
 * These info are for clinet side to show some dummy icon for Miix movie which is under rendering
 * 
 * @param {String} doohID
 * @param {String} miixMovieProjectID
 */
miixContentMgr.preAddMiixMovie = function() {
    
};

/**
 * Add a Miix image to system. &lt;br>  
 * &lt;br>
 * Miix image content body (in base64 format) is saved as a PNG and put onto AWS S3; the complete set of  
 * content info is save to UGC db
 * 
 * @param {String} imgBase64 image date with base64 format
 * @param {String} ugcProjectID Project ID of this UGC
 * @param {Object} ownerId An object containing owner's id info:
 *     &lt;ul>
 *     &lt;li>_id: owner's member ID (hex string representation of its ObjectID in MongoDB)
 *     &lt;li>fbId: owner's Facebook ID
 *     &lt;/ul>
 * @param {String} title Tile of UGC
 */
miixContentMgr.addMiixImage = function(imgBase64, ugcProjectID, ownerId, title) {
    
};

/**
 * Get the url of user-uploaded image &lt;br>  
 * 
 * @param {String} miixMovieProjectID
 * @param {Function} gotUrls_cb
 */
miixContentMgr.getUserUploadedImageUrls = function( miixMovieProjectID, gotUrls_cb) {
    var userUploadedImageUrls = new Array();
    var anUserUploadedImageUrl;
    var userContentXmlFile = path.join( workingPath, 'public/contents/user_project', miixMovieProjectID, 'user_data/customized_content.xml')
    var parser = new xml2js.Parser({explicitArray: false});
    fs.readFile( userContentXmlFile, function(err, data) {
        if (!err){
            parser.parseString(data, function (err2, result) {
                if (!err2){
                    var customizable_objects = result.customized_content.customizable_object_list.customizable_object;
                    
                    if( Object.prototype.toString.call( customizable_objects ) === '[object Array]' ){
                        for (var i=0;i&lt;customizable_objects.length;i++) {
                            anUserUploadedImageUrl = '/contents/user_project/'+miixMovieProjectID+'/user_data/'+customizable_objects[i].content;
                            userUploadedImageUrls.push( anUserUploadedImageUrl );
                        }
                    }
                    else{
                        anUserUploadedImageUrl = '/contents/user_project/'+miixMovieProjectID+'/user_data/'+customizable_objects.content;
                        userUploadedImageUrls.push( anUserUploadedImageUrl );
                    }
                    if (gotUrls_cb) {
                        gotUrls_cb(userUploadedImageUrls, null);
                    }
                }
                else{
                    if (gotUrls_cb) {
                        gotUrls_cb(null, err2);
                    }
                }
            });
        }
        else {
            if (gotUrls_cb) {
                gotUrls_cb(null, err);
            }		
        }
    });
};



module.exports = miixContentMgr;

/*
//test
miixContentMgr.getUserUploadedImageUrls('greeting-50c99d81064d2b841200000a-20130129T072747490Z', function(userUploadedImageUrls, err){
    console.log('userUploadedImageUrls=');
    console.dir(userUploadedImageUrls);
});
*/</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Namespaces</h3><ul><li><a href="miix.html">miix</a></li><li><a href="miix_admin.html">miix_admin</a></li></ul><h3>Mixins</h3><ul><li><a href="customerServiceMgr.html">customerServiceMgr</a></li><li><a href="miixContentMgr.html">miixContentMgr</a></li><li><a href="scalaMgr.html">scalaMgr</a></li><li><a href="scheduleMgr.html">scheduleMgr</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a> on Thu Jul 18 2013 16:38:19 GMT+0800 (TST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
